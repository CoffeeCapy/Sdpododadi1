<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Foba Legends - Fixed</title>
  <style>
    body { margin:0; background:#000; overflow:hidden; font-family:Arial; touch-action:none; }
    /* Pastikan Kanvas di paling belakang */
    canvas { display:block; position:absolute; top:0; left:0; z-index:1; }
    
    #stats {
      position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); 
      padding:10px; border-radius:8px; z-index:10; color: #fff;
    }
    
    #hud {
      position:absolute; bottom:20px; right:20px; display:flex; flex-direction:column-reverse; gap:10px; z-index:20;
    }
    .skill {
      width:70px; height:70px; background:rgba(20,20,40,0.9); border:3px solid #555;
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-size:24px; color:#fff; font-weight:bold; position:relative;
    }
    .skill.ready { border-color:#ffcc00; box-shadow:0 0 15px #ffcc00; }
    .cd { position:absolute; color:#ff4444; font-size:18px; pointer-events:none; }

    #joystick {
      position:absolute; bottom:40px; left:40px; width:120px; height:120px;
      background:rgba(255,255,255,0.1); border-radius:50%; z-index:15;
    }
    #knob {
      position:absolute; width:50px; height:50px; background:#ffcc00;
      border-radius:50%; top:50%; left:50%; transform:translate(-50%,-50%);
    }
  </style>
</head>
<body>

<div id="stats">HP: <span id="hp">1000</span> | Gold: <span id="gold">0</span> | Kills: <span id="kills">0</span></div>

<div id="hud">
  <div class="skill ready" onclick="castSkill('R')">R<div class="cd" id="cdR"></div></div>
  <div class="skill ready" onclick="castSkill('E')">E<div class="cd" id="cdE"></div></div>
  <div class="skill ready" onclick="castSkill('W')">W<div class="cd" id="cdW"></div></div>
  <div class="skill ready" onclick="castSkill('Q')">Q<div class="cd" id="cdQ"></div></div>
</div>

<div id="joystick"><div id="knob"></div></div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Variabel Game
let hero = { x: 200, y: 300, hp: 1000, maxHp: 1000, size: 25, gold: 0 };
let enemies = [], projectiles = [], kills = 0;
let joy = { active: false, angle: 0, power: 0 };
const skills = {
  Q: { cd: 0, maxCd: 100 }, W: { cd: 0, maxCd: 200 },
  E: { cd: 0, maxCd: 300 }, R: { cd: 0, maxCd: 600 }
};

// --- KONTROL JOYSTICK ---
const knob = document.getElementById('knob');
window.addEventListener('touchstart', e => {
  const t = e.touches[0];
  if (t.clientX < window.innerWidth / 2) { // Sisi kiri untuk jalan
    joy.active = true;
  }
});

window.addEventListener('touchmove', e => {
  if (!joy.active) return;
  const t = e.touches[0];
  const jX = 100, jY = window.innerHeight - 100; // Posisi joystick
  const dx = t.clientX - jX, dy = t.clientY - jY;
  const dist = Math.hypot(dx, dy);
  joy.angle = Math.atan2(dy, dx);
  joy.power = Math.min(1, dist / 60);
  knob.style.transform = `translate(-50%,-50%) translate(${Math.cos(joy.angle)*joy.power*30}px, ${Math.sin(joy.angle)*joy.power*30}px)`;
});

window.addEventListener('touchend', () => {
  joy.active = false;
  knob.style.transform = 'translate(-50%,-50%)';
});

// --- SKILL SYSTEM ---
window.castSkill = function(type) {
  if (skills[type].cd > 0) return;
  skills[type].cd = skills[type].maxCd;
  
  if (type === 'Q') {
    projectiles.push({ x: hero.x, y: hero.y, vx: Math.cos(joy.angle || 0)*10, vy: Math.sin(joy.angle || 0)*10, life: 60 });
  } else if (type === 'W') {
    hero.x += Math.cos(joy.angle)*100; hero.y += Math.sin(joy.angle)*100;
  }
};

function update() {
  if (joy.active) {
    hero.x += Math.cos(joy.angle) * 4 * joy.power;
    hero.y += Math.sin(joy.angle) * 4 * joy.power;
  }

  // Cooldown
  Object.keys(skills).forEach(s => {
    if (skills[s].cd > 0) skills[s].cd--;
    document.getElementById('cd'+s).innerText = skills[s].cd > 0 ? Math.ceil(skills[s].cd/60) : '';
  });

  // Enemy Spawn
  if (Math.random() < 0.01 && enemies.length < 5) {
    enemies.push({ x: canvas.width, y: Math.random()*canvas.height, hp: 100 });
  }

  // Collision & Projectile Update
  projectiles.forEach((p, pi) => {
    p.x += p.vx; p.y += p.vy; p.life--;
    enemies.forEach((en, ei) => {
      if (Math.hypot(p.x - en.x, p.y - en.y) < 30) {
        en.hp -= 50; p.life = 0;
        if (en.hp <= 0) { enemies.splice(ei, 1); kills++; hero.gold += 50; }
      }
    });
    if (p.life <= 0) projectiles.splice(pi, 1);
  });

  document.getElementById('hp').innerText = Math.floor(hero.hp);
  document.getElementById('gold').innerText = hero.gold;
  document.getElementById('kills').innerText = kills;
}

function draw() {
  // 1. Background (Ini yang bikin nggak gelap lagi)
  ctx.fillStyle = '#1a472a'; // Warna rumput gelap
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // 2. Garis Map
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  for(let i=0; i<canvas.width; i+=100) {
    ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke();
  }

  // 3. Hero
  ctx.fillStyle = '#00d4ff';
  ctx.beginPath(); ctx.arc(hero.x, hero.y, hero.size, 0, Math.PI*2); ctx.fill();

  // 4. Enemies
  ctx.fillStyle = '#ff4444';
  enemies.forEach(en => {
    ctx.beginPath(); ctx.arc(en.x, en.y, 25, 0, Math.PI*2); ctx.fill();
  });

  // 5. Projectiles
  ctx.fillStyle = '#ffff00';
  projectiles.forEach(p => {
    ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
  });
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
